# name: Docker Build and Deploy

# on:
#   workflow_call:
#     inputs:
#       github_actor:
#         required: true
#         type: string
#       github_token:
#         required: true
#         type: string
#       ssh_enable:
#         required: true
#         type: string
#       ssh_host:
#         required: true
#         type: string
#       ssh_user:
#         required: true
#         type: string
#       ssh_port:
#         required: true
#         type: string
#       ssh_private_key:
#         required: true
#         type: string
#       deploy_folder_path:
#         required: true
#         type: string
#       deploy_command:
#         required: true
#         type: string
#       discord_webhook_id:
#         required: true
#         type: string
#       discord_webhook_token:
#         required: true
#         type: string
#       discord_enable:
#         required: true
#         type: string

# jobs:
#   build:
#     uses: devopsprabin/workflows/.github/workflows/docker-build.yml@main
#     with:
#       github_token: ${{ inputs.github_token }}
#       github_actor: ${{ inputs.github_actor }}

#   deploy:
#     needs: build
#     uses: devopsprabin/workflows/.github/workflows/deploy.yml@main
#     with:
#       ssh_enable: ${{ inputs.ssh_enable }}
#       ssh_host: ${{ inputs.ssh_host }}
#       ssh_user: ${{ inputs.ssh_user }}
#       ssh_port: ${{ inputs.ssh_port }}
#       ssh_private_key: ${{ inputs.ssh_private_key }}
#       deploy_folder_path: ${{ inputs.deploy_folder_path }}
#       deploy_command: ${{ inputs.deploy_command }}

#   notify:
#     needs: deploy
#     uses: devopsprabin/workflows/.github/workflows/discord-notify.yml@main
#     with:
#       discord_webhook_id: ${{ inputs.discord_webhook_id }}
#       discord_webhook_token: ${{ inputs.discord_webhook_token }}
#       discord_enable: ${{ inputs.discord_enable }}


name: CI/CD Workflow

on:
  workflow_call:
    inputs:
      github_token:
        required: true
        type: string
      github_actor:
        required: true
        type: string

      # Build args
      custom_tag_name:
        required: true
        type: string
      image_name:
        required: false
        type: string
      subdirectory:
        required: false
        type: string
        default: ""
      dockerfile_name:
        required: false
        type: string
        default: Dockerfile
      build_args:
        required: false
        type: string
        default: |
          _ENV=development

      # Deploy args
      ssh_enable:
        required: true
        type: string
      ssh_host:
        required: true
        type: string
      ssh_user:
        required: true
        type: string
      ssh_port:
        required: true
        type: string
      ssh_private_key:
        required: true
        type: string
      deploy_folder_path:
        required: true
        type: string
      deploy_command:
        required: true
        type: string

      # Notify args
      discord_webhook_id:
        required: true
        type: string
      discord_webhook_token:
        required: true
        type: string
      discord_enable:
        required: true
        type: string

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.git_token }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ./${{ inputs.subdirectory }}
          file: ${{ inputs.dockerfile_name }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ inputs.subdirectory != '' && inputs.subdirectory || github.event.repository.name }}:${{ inputs.custom_tag_name }}
            ${{ inputs.image_name }}
          build-args: |
            ${{ inputs.build_args }}
            GIT_TOKEN=${{ secrets.git_token }}


  # deploy:
  #   needs: build
  #   uses: devopsprabin/workflows/.github/workflows/deploy.yml@main
  #   with:
  #     ssh_enable: ${{ inputs.ssh_enable }}
  #     ssh_host: ${{ inputs.ssh_host }}
  #     ssh_user: ${{ inputs.ssh_user }}
  #     ssh_port: ${{ inputs.ssh_port }}
  #     ssh_private_key: ${{ inputs.ssh_private_key }}
  #     deploy_folder_path: ${{ inputs.deploy_folder_path }}
  #     deploy_command: ${{ inputs.deploy_command }}

  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Success Notification to Discord
        if: ${{ success() && inputs.discord_enable == 'true' }}
        uses: appleboy/discord-action@master
        with:
          webhook_id: ${{ secrets.discord_webhook_id }}
          webhook_token: ${{ secrets.discord_webhook_token }}
          username: ${{ github.event.sender.login }}
          avatar_url: ${{ github.event.sender.avatar_url }}
          args: |
            ‚úÖ **Successfully Deployed:** ${{ github.event.repository.name }}
            üîπ **Image Tag:** `${{ inputs.custom_tag_name }}`
            üîπ **Commit:** `${{ github.event.head_commit.message }}`
            üîπ **Branch:** `${{ github.ref_name }}`

      - name: Send Failure Notification to Discord
        if: ${{ failure() && inputs.discord_enable == 'true' }}
        uses: appleboy/discord-action@master
        with:
          webhook_id: ${{ secrets.discord_webhook_id }}
          webhook_token: ${{ secrets.discord_webhook_token }}
          username: ${{ github.event.sender.login }}
          avatar_url: ${{ github.event.sender.avatar_url }}
          args: |
            üî¥ **Failed Deployment:** ${{ github.event.repository.name }}
            ‚ùå **Image Tag:** `${{ inputs.custom_tag_name }}`
            ‚ùå **Deployment URL:** [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚ùå **Commit:** `${{ github.event.head_commit.message }}`
            ‚ùå **Branch:** `${{ github.ref_name }}`
